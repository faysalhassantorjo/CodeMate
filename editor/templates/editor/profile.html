<!DOCTYPE html>
<html lang="en">
{% load static %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ user_profile.user.username }}'s Profile | CodeCollab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #e00000;
        }

        :root {
            --color-bg: #1e1e1e;
            --color-bg-secondary: #252526;
        }

        .online-dot {
            box-shadow: 0 0 0 2px #1f2937;
        }

        .tab-active {
            border-bottom: 2px solid #818cf8;
            color: white;
        }

        .tab-inactive {
            color: #9ca3af;
        }

        .code-block {
            background-color: #1e1e1e;
            font-family: 'Fira Code', monospace;
        }

        .channel-card:hover {
            transform: translateY(-2px);
            transition: transform 0.2s ease;
        }

        .content-section {
            display: none;
        }

        .content-active {
            display: block;
        }
    </style>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/9.1.0/mdb.min.css" rel="stylesheet" />
</head>

<body class="text-gray-100" style="background: var(--color-bg);">
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Profile Header -->
        <div class="rounded-xl overflow-hidden mb-8" style="background: var(--color-bg-secondary);">
            <!-- Cover Photo -->
            <div class="h-48 bg-gradient-to-r from-indigo-900 to-gray-900 relative">
                <div class="absolute bottom-4 right-4">
                    {% if user_profile.user.id == request.user.id %}
                    <button
                        class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg text-sm font-medium transition">
                        <i class="fas fa-camera mr-2"></i>Change Cover
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- Profile Info -->
            <div class="px-8 pb-8 relative">
                <div class="absolute -top-16 left-8 border-4 border-gray-800 rounded-full">
                    <img src="{{ user_profile.profile_picture.url }}" alt="Profile Picture"
                        class="w-32 h-32 rounded-full object-cover shadow-lg">
                    <div class="absolute bottom-2 right-2 w-6 h-6 rounded-full bg-green-500 online-dot 
                                {% if not user_profile.is_online %}hidden{% endif %}"></div>
                </div>

                <div class="pt-20 flex justify-between items-start">
                    <div>
                        <h1 class="text-3xl font-bold">{{ user_profile.user.username }}</h1>
                        <div class="flex items-center mt-2 space-x-4">
                            <span class="flex items-center text-gray-400">
                                <i
                                    class="fas fa-circle text-xs mr-2 {% if user_profile.is_online %}text-green-500{% else %}text-gray-500{% endif %}"></i>
                                {% if user_profile.is_online %}Online now{% else %}Last seen {{
                                user_profile.last_activity|timesince }} ago{% endif %}
                            </span>
                            <span class="text-gray-600">|</span>
                            <span class="text-gray-400"><i class="fas fa-calendar-alt mr-2"></i>Joined
                                {{user_profile.user.date_joined|date:"M Y" }}</span>
                        </div>
                    </div>

                    {% if is_owner %}
                    <button
                        class="bg-indigo-600 hover:bg-indigo-700 px-6 py-2 rounded-lg font-medium transition flex items-center">
                        <i class="fas fa-edit mr-2"></i> Edit Profile
                    </button>
                    {% else %}
                    <div class="flex space-x-3">
                        <button
                            class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-comment-dots mr-2"></i> Message
                        </button>
                        <button
                            class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-user-plus mr-2"></i> Follow
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>





        <!-- Tabs navs -->
        <ul class="nav nav-tabs mb-3" id="ex-with-icons" role="tablist">
            <li class="nav-item" role="presentation">
                <a data-mdb-tab-init class="nav-link active" id="ex-with-icons-tab-1" href="#activity" role="tab"
                    aria-controls="activity" aria-selected="false"><i
                        class="fas fa-chart-pie fa-fw me-2"></i>Activity</a>
            </li>
            <li class="nav-item" role="presentation">
                <a data-mdb-tab-init class="nav-link" id="ex-with-icons-tab-2" href="#container" role="tab"
                    aria-controls="container" aria-selected="false"><i
                        class="fas fa-chart-line fa-fw me-2"></i>Container</a>
            </li>
            <li class="nav-item" role="presentation">
                <a data-mdb-tab-init class="nav-link" id="ex-with-icons-tab-3" href="#channels" role="tab"
                    aria-controls="channel" aria-selected="false"><i class="fas fa-cogs fa-fw me-2"></i>Channel</a>
            </li>
        </ul>
        <style>
            .nav-tabs .nav-link {
                color: #b6b6b6 !important;
                background-color: var(--color-bg-secondary) !important;
            }

            .nav-tabs .nav-link:hover {
                color: #ffffff !important;
            }

            .nav-tabs .nav-link.active {
                color: #ffffff !important;
                border-color: #ffffff !important;
            }
        </style>
        <!-- Tabs navs -->

        <!-- Tabs content -->
        <div class="tab-content" id="ex-with-icons-content">
            <div class="tab-pane fade show active" id="activity" role="tabpanel" aria-labelledby="ex-with-icons-tab-1 ">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Column -->
                    <!-- <div class="lg:col-span-2">
                        <div class="rounded-xl p-6 mb-8" style="background: var(--color-bg-secondary);">
                            <h2 class="text-xl font-bold mb-6 flex items-center">
                                <i class="fas fa-history mr-3 text-indigo-400"></i> Recent Activity
                            </h2>

                            <div class="space-y-6">
                                <div class="flex space-x-4">
                                    <div class="flex-shrink-0">
                                        <div
                                            class="w-12 h-12 bg-indigo-900 rounded-full flex items-center justify-center">
                                            <i class="fas fa-code text-indigo-400"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex items-center space-x-2">
                                            <span class="font-medium">Created new file</span>
                                            <span class="text-gray-400 text-sm">2 hours ago</span>
                                        </div>
                                        <p class="text-gray-400 mt-1">main.py in <a href="#"
                                                class="text-indigo-400 hover:underline">Python Team</a></p>
                                        <div class="code-block rounded-lg p-4 mt-3 text-sm overflow-x-auto">
                                            <pre><code class="text-gray-300">def hello_world():
    print("Hello, World!")</code></pre>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex space-x-4">
                                    <div class="flex-shrink-0">
                                        <div
                                            class="w-12 h-12 bg-purple-900 rounded-full flex items-center justify-center">
                                            <i class="fas fa-comment text-purple-400"></i>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex items-center space-x-2">
                                            <span class="font-medium">Posted message</span>
                                            <span class="text-gray-400 text-sm">5 hours ago</span>
                                        </div>
                                        <p class="text-gray-400 mt-1">in <a href="#"
                                                class="text-indigo-400 hover:underline">Web Dev Group</a></p>
                                        <div class="bg-gray-700 rounded-lg p-4 mt-3">
                                            <p>"Has anyone worked with Django Channels before? I need help with
                                                WebSocket implementation."</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> -->

                    <!-- Right Column -->
                    <div>
                        <!-- About Section -->
                        <div class="rounded-xl p-6 mb-8" style="background: var(--color-bg-secondary);">
                            <h2 class="text-xl font-bold mb-4 flex items-center">
                                <i class="fas fa-user mr-3 text-indigo-400"></i> About
                            </h2>
                            <div class="space-y-4">
                                <div>
                                    <h3 class="text-gray-400 text-sm">BIO</h3>
                                    <p class="mt-1">
                                        {% if user_profile.bio %}
                                        {{ user_profile.bio }}
                                        {% else %}
                                        No bio yet
                                        {% endif %}
                                    </p>
                                </div>
                                <div>
                                    <h3 class="text-gray-400 text-sm">SKILLS</h3>
                                    <div class="flex flex-wrap gap-2 mt-2">
                                        <span
                                            class="bg-indigo-900 text-indigo-300 px-3 py-1 rounded-full text-sm">Python</span>
                                        <span
                                            class="bg-indigo-900 text-indigo-300 px-3 py-1 rounded-full text-sm">Django</span>
                                        <span
                                            class="bg-indigo-900 text-indigo-300 px-3 py-1 rounded-full text-sm">JavaScript</span>
                                        {% if is_owner %}
                                        <button class="text-gray-400 hover:text-indigo-400">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="container" role="tabpanel" aria-labelledby="ex-with-icons-tab-2">
                {% if user.userprofile.usercontainer %}
                <div class="rounded-2xl p-8 space-y-6" style="background: var(--color-bg-secondary);">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-semibold text-white flex items-center">
                            <i class="fas fa-box mr-3 text-indigo-400"></i> My Container
                        </h2>
                        <span id="status"
                            class="{% if status == 'running' %}bg-green-500{% else %}bg-red-500{% endif %} text-white text-xs px-3 py-1 rounded-full font-semibold">
                            {% if status == "running" %}Running{% else %}Stopped{% endif %}
                        </span>
                    </div>

                    <!-- Container ID -->
                    <div class="text-gray-300">
                        <strong class="block text-sm text-gray-400 uppercase">Container ID</strong>
                        <p class="mt-1 text-base">{{ user.userprofile.usercontainer.container_id }}</p>
                    </div>

                    <!-- Installed Packages -->
                    <div>
                        <h3 class="text-gray-400 text-sm uppercase mb-2">Installed Packages</h3>
                        <div
                            class="bg-gray-900 border border-gray-700 rounded-lg p-4 text-gray-100 text-sm overflow-x-auto max-h-48">
                            {% if user.userprofile.usercontainer.installed_packages %}
                            {% for package in user.userprofile.usercontainer.installed_packages.splitlines %}
                            <div class="border-b border-gray-700 py-1">{{ package }}</div>
                            {% empty %}
                            <p class="text-gray-500">No packages installed.</p>
                            {% endfor %}
                            {% else %}
                            <p class="text-gray-500">No packages installed.</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center space-x-3 flex-wrap">
                        {% if status != "running" %}
                        <button id="startContainerBtn"
                            class="inline-flex items-center bg-green-600 hover:bg-green-700 text-white text-sm font-medium px-4 py-2 rounded-md transition">
                            <i class="fas fa-play mr-2"></i> Start Container
                        </button>
                        {% endif %}

                        <a href="{% url 'delete_container' %}"
                            class="inline-flex items-center bg-red-600 hover:bg-red-700 text-white text-sm font-medium px-4 py-2 rounded-md transition">
                            <i class="fas fa-trash mr-2"></i> Delete Container
                        </a>
                    </div>

                    <p id="startMsg" class="text-green-400 mt-4 hidden text-sm font-medium"></p>
                </div>
                {% else %}
                <div class="bg-gray-800 rounded-2xl shadow-xl p-8 text-center">
                    <h2 class="text-2xl font-semibold text-white flex items-center justify-center mb-4">
                        <i class="fas fa-box-open mr-3 text-indigo-400"></i> No Container Found
                    </h2>
                    <p class="text-gray-400 mb-6">You don't have a container yet.</p>
                    <a href="{% url 'create_container' %}"
                        class="inline-flex items-center bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium px-5 py-2 rounded-md transition">
                        <i class="fas fa-plus mr-2"></i> Create Container
                    </a>
                </div>
                {% endif %}
            </div>


            <!-- start the container ajax  -->
            <script>
                const startBtn = document.getElementById('startContainerBtn');
                const startMsg = document.getElementById('startMsg');

                if (startBtn) {
                    startBtn.addEventListener('click', () => {
                        fetch('{% url "start_container" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({
                                user_id: '{{ user.id }}'
                            })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    startMsg.textContent = `Container started! It will stop automatically after ${data.auto_stop_in} seconds.`;
                                    startMsg.classList.remove('hidden');
                                    let status = document.getElementById('status')
                                    status.innerText = data.container_status
                                    status.classList.replace('bg-red-600', 'bg-green-600')
                                    startBtn.style.display = 'none'
                                } else {
                                    startMsg.textContent = `Failed to start container: ${data.message}`;
                                    startMsg.classList.remove('hidden');
                                    startMsg.classList.remove('text-green-400');
                                    startMsg.classList.add('text-red-400');
                                }
                            })
                            .catch(err => {
                                startMsg.textContent = `Something went wrong.`;
                                startMsg.classList.remove('hidden');
                                startMsg.classList.remove('text-green-400');
                                startMsg.classList.add('text-red-400');
                            });
                    });
                }
            </script>




            <div class="tab-pane fade" id="channels" role="tabpanel" aria-labelledby="channels-tab">
                <!-- Channels Section -->
                <div class="rounded-xl p-6" style="background: var(--color-bg-secondary);">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-users mr-3 text-indigo-400"></i> Channels
                    </h2>
                    <div class="space-y-3">
                        {% for channel in user_profile.created_rooms.all %}
                        <a href="#" class="channel-card block rounded-lg p-4 transition"
                            style="background: var(--color-bg-secondary);">
                            <div class="flex items-center space-x-3">
                                <img src="{{ channel.channel_picture.url }}" alt="{{ channel.name }}"
                                    class="w-10 h-10 rounded-full">
                                <div>
                                    <h3 class="font-medium">{{ channel.name }}</h3>
                                    <p class="text-gray-400 text-sm">{{ channel.participants.count }} members
                                    </p>
                                </div>
                            </div>
                        </a>
                        {% endfor %}

                        {% if user_channels.count > 5 %}
                        <button class="text-indigo-400 text-sm font-medium mt-2 hover:underline">
                            View all {{ user_channels.count }} channels →
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <!-- Tabs content -->


    </main>

    <!-- Footer -->
    <footer class="py-6 mt-12" style="background: var(--color-bg-secondary);">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-400 text-sm">
            <p>© 2023 CodeCollab. All rights reserved.</p>
        </div>
    </footer>

    <script>
        window.name = "{{ user_profile.user.username }}"


        // Online status check
        function checkOnlineStatus() {
            fetch('/api/check-online/{{ user_profile.user.id }}/')
                .then(response => response.json())
                .then(data => {
                    const onlineDot = document.querySelector('.online-dot');
                    const statusText = document.querySelector('.status-text');

                    if (data.is_online) {
                        onlineDot.classList.remove('hidden');
                        onlineDot.classList.add('bg-green-500');
                        statusText.textContent = 'Online now';
                    } else {
                        onlineDot.classList.add('hidden');
                        statusText.textContent = `Last seen ${data.last_activity} ago`;
                    }
                });
        }

        // Check every minute
        setInterval(checkOnlineStatus, 60000);
    </script>
    <!-- MDB -->
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/9.1.0/mdb.umd.min.js"></script>
    <script src="{% static 'editor/js/permission_socket.js' %}"></script>
</body>

</html>